<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopify Product Importer</title>
    
    <!-- Shopify App Bridge required meta tags -->
    <meta name="shopify-client-id" content="%SHOPIFY_API_KEY%" />
    <meta name="shopify-shop-domain" content="%SHOP%" />
    <meta name="shopify-host" content="%HOST%" />
    <meta name="shopify-embedded" content="%EMBEDDED%" />
    <meta name="shopify-debug" content="true" />
    
    <!-- æ—©æœŸé”™è¯¯æ‹¦æˆªå™¨ - å¿…é¡»åœ¨ä»»ä½•å…¶ä»–è„šæœ¬ä¹‹å‰ -->
    <script>
      // æ£€æµ‹Cloudflareç¯å¢ƒ
      const isCloudflareEnv = window.location.hostname.includes('.trycloudflare.com') ||
                              window.location.hostname.includes('.amoze.cc');
      
      // æ—©æœŸæ‹¦æˆªWebSocketå’ŒHTTP2é”™è¯¯
      if (isCloudflareEnv) {
        console.log('ğŸŒ æ¿€æ´»Cloudflareéš§é“æ¨¡å¼é”™è¯¯æ‹¦æˆªå™¨');
        
        // ç«‹å³åŠ«æŒWebSocketä»¥é˜»æ­¢HMRè¿æ¥
        const OriginalWebSocket = window.WebSocket;
        window.WebSocket = function(url, protocols) {
          const urlStr = url.toString();
          if (urlStr.includes('24678') || urlStr.includes('0.0.0.0')) {
            console.debug('ğŸŒ é˜»æ­¢HMR WebSocketè¿æ¥:', urlStr);
            // è¿”å›ä¸€ä¸ªç«‹å³å…³é—­çš„æ¨¡æ‹ŸWebSocket
            const mock = {
              readyState: 3,
              close: function() {},
              send: function() {},
              addEventListener: function() {},
              removeEventListener: function() {},
              dispatchEvent: function() { return false; },
              onopen: null,
              onclose: null,
              onerror: null,
              onmessage: null
            };
            setTimeout(() => {
              if (mock.onclose) mock.onclose({code: 1000, reason: 'Blocked'});
            }, 1);
            return mock;
          }
          return new OriginalWebSocket(url, protocols);
        };
        // å¤åˆ¶é™æ€å±æ€§
        window.WebSocket.CONNECTING = 0;
        window.WebSocket.OPEN = 1;
        window.WebSocket.CLOSING = 2;
        window.WebSocket.CLOSED = 3;
        
        // æ‹¦æˆªconsole.error
        const originalConsoleError = console.error;
        console.error = function(...args) {
          const message = args.join(' ');
          // è¿‡æ»¤WebSocketå’ŒHTTP2åè®®é”™è¯¯
          if (message.includes('WebSocket') || 
              message.includes('24678') || 
              message.includes('wss://0.0.0.0:24678') ||
              message.includes('ERR_HTTP2_PROTOCOL_ERROR') ||
              message.includes('PROTOCOL_ERROR') ||
              message.includes('failed to connect to websocket') ||
              message.includes('0.0.0.0:24678') ||
              message.includes('createConnection') ||
              message.includes('client:802') ||
              message.includes('client:437') ||
              message.includes('client:811') ||
              message.includes('client:290') ||
              message.includes('client:383') ||
              message.includes('client:908')) {
            console.debug('ğŸŒ å·²æ‹¦æˆªWebSocketé”™è¯¯');
            return; // é™é»˜å¤„ç†
          }
          originalConsoleError.apply(console, args);
        };

        // æ‹¦æˆªå…¨å±€é”™è¯¯
        window.addEventListener('error', function(event) {
          const message = event.message || (event.error && event.error.message) || '';
          const source = event.filename || '';
          if (message.includes('WebSocket') || 
              message.includes('24678') || 
              message.includes('wss://0.0.0.0:24678') ||
              message.includes('ERR_HTTP2_PROTOCOL_ERROR') ||
              message.includes('PROTOCOL_ERROR') ||
              message.includes('createConnection') ||
              source.includes('client:802') ||
              source.includes('client:437') ||
              source.includes('client:811') ||
              source.includes('client:290') ||
              source.includes('client:383') ||
              source.includes('client:908')) {
            console.debug('ğŸŒ å·²æ‹¦æˆªå…¨å±€WebSocketé”™è¯¯');
            event.preventDefault();
            event.stopPropagation();
            return false;
          }
        }, true);

        // æ‹¦æˆªPromiseé”™è¯¯
        window.addEventListener('unhandledrejection', function(event) {
          const message = event.reason && event.reason.message || event.reason || '';
          if (message.includes && (message.includes('WebSocket') || 
              message.includes('24678') || 
              message.includes('ERR_HTTP2_PROTOCOL_ERROR') ||
              message.includes('PROTOCOL_ERROR'))) {
            event.preventDefault();
            return false;
          }
        }, true);
      }
    </script>

    <!-- App Bridge - å¿…é¡»ä½œä¸ºç¬¬ä¸€ä¸ªscriptæ ‡ç­¾åŒæ­¥åŠ è½½ -->
    <script>
      // æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½App Bridge
      const needsAppBridge = window.location.search.includes('shop=') || 
                            (document.querySelector('meta[name="shopify-shop-domain"]')?.content !== '%SHOP%' && 
                             document.querySelector('meta[name="shopify-shop-domain"]')?.content !== '');
      
      if (needsAppBridge) {
        // åŒæ­¥åŠ è½½App Bridgeï¼Œç¡®ä¿å®ƒæ˜¯ç¬¬ä¸€ä¸ªè„šæœ¬
        document.write('<script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"><\/script>');
      }
    </script>
  </head>
  <body>
    <div id="root"></div>
    <!-- Build tools will replace the script tag below -->
    <script type="module" src="/client/main.tsx"></script>
  </body>
</html> 